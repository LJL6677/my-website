<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高斯投影教学演示系统 (V4.9 曲线修正版)</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --highlight: #c0392b;
            --yellow-line: #f1c40f;
            --bg: #f4f6f9;
            --text: #333;
        }

        body { margin: 0; font-family: "Microsoft YaHei", "Segoe UI", sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; color: var(--text); }

        /* 侧边栏 */
        .sidebar { width: 240px; background: var(--primary); color: #fff; padding: 20px; display: flex; flex-direction: column; z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .logo { font-size: 1.1rem; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; margin-bottom: 20px; }
        .nav-btn { background: transparent; border: none; color: rgba(255,255,255,0.7); text-align: left; padding: 12px; cursor: pointer; border-radius: 4px; margin-bottom: 5px; font-size: 0.95rem; transition: 0.3s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .nav-btn.active { background: var(--accent); color: #fff; font-weight: bold; border-left: 4px solid #fff; }

        /* 主区域 */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .panel { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.3s; }
        .panel.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .header { 
            background: #fff; padding: 15px 20px; border-bottom: 1px solid #ddd; 
            font-weight: bold; color: var(--primary); font-size: 1.1rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .course-info {
            font-size: 0.85rem; color: #666; font-weight: normal;
            display: flex; flex-direction: column; align-items: flex-start;
        }
        .course-info span {
            background: #f0f0f0; padding: 3px 8px; border-radius: 3px; margin-left: 5px;
        }
        .competition-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* 通用按钮 */
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; color: #fff; background: var(--primary); margin-right: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-outline { background: #fff; border: 1px solid var(--accent); color: var(--accent); width: 100%; text-align: left; margin-bottom: 8px; }
        .btn-outline:hover { background: #eaf2f8; }

        /* --- 功能1：投影变形 --- */
        .split-container { display: flex; flex: 1; overflow: hidden; }
        .canvas-box { flex: 1; position: relative; background: #fff; cursor: crosshair; }
        canvas { display: block; width: 100%; height: 100%; }
        
        .side-panel { width: 340px; background: #fdfdfd; border-left: 1px solid #ddd; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .conclusion-box { 
            display: none; padding: 15px; background: #e8f8f5; 
            border-left: 5px solid #1abc9c; margin-bottom: 15px; 
            font-size: 0.9rem; line-height: 1.6; border-radius: 4px;
        }

        /* --- 功能2：分带计算 --- */
        .calc-container { padding: 20px; flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
        .input-area { 
            background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .input-area input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 120px; }
        
        .control-buttons {
            display: flex; gap: 10px; margin-top: 10px; width: 100%;
        }
        .zone-btn {
            background: #f0f0f0; border: 1px solid #ccc; padding: 6px 12px; 
            border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: #333;
        }
        .zone-btn.active {
            background: var(--accent); color: white; border-color: var(--accent);
        }
        
        .track-display { 
            position: relative; height: 450px; background: #fff; border: 1px solid #ccc; 
            border-radius: 8px; overflow: auto; margin-bottom: 20px;  /* 改为auto，允许滚动 */
            min-height: 450px; /* 最小高度确保有足够空间 */
        }
        .track-lane { position: absolute; height: 80px; width: 100%; }
        .zone-block { 
            position: absolute; height: 60px; border: 1px solid #bbb; background: #f9f9f9; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 12px; box-sizing: border-box; cursor: pointer;
        }
        .zone-block.active { background: #d6eaf8; border: 2px solid var(--accent); z-index: 10; font-weight: bold; }
        
        /* 中央经线标记 */
        .center-line-dashed {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 0;
            border-left: 2px dashed var(--yellow-line); z-index: 50;
        }
        .center-label {
            position: absolute; left: 50%; top: 5px; transform: translateX(-50%);
            background: var(--yellow-line); color: #000; padding: 2px 6px; 
            border-radius: 4px; font-size: 10px; font-weight: bold; z-index: 51;
        }
        
        /* 分带子午线样式 */
        .division-line-6 {
            position: absolute; top: 0; bottom: 0; width: 0;
            border-left: 1px dashed #e74c3c; z-index: 40;
            opacity: 0.6;
        }
        .division-line-3 {
            position: absolute; top: 185px; bottom: 0; width: 0;
            border-left: 1px dashed #27ae60; z-index: 40;
            opacity: 0.6;
        }
        .division-label {
            position: absolute; font-size: 9px; color: #fff; padding: 1px 3px; 
            border-radius: 2px; z-index: 41; transform: translateX(-50%);
            white-space: nowrap;
        }

        .formula-container {
            background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
        }
        .formula-panel { 
            display: none; background: #fff8e1; padding: 20px; border: 1px solid #ffe082; 
            border-radius: 8px; margin-top: 10px;
        }
        .formula-row {
            display: flex; margin-bottom: 15px; align-items: center;
        }
        .formula-label {
            width: 150px; font-weight: bold; color: #333;
        }
        .formula-equation {
            flex: 1; font-family: "Cambria Math", serif; font-size: 1.1rem; color: #c0392b;
        }
        .formula-result {
            width: 120px; text-align: center; font-weight: bold; color: var(--accent);
        }
        
        .theory-box {
            background: #f9f9f9; padding: 15px; border-radius: 8px; border-left: 5px solid #9b59b6;
            margin-bottom: 20px; font-size: 0.9rem; line-height: 1.6;
        }

        /* --- 功能3：坐标平移 --- */
        .coord-layout { 
            padding: 20px; 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; /* 改为auto，允许滚动 */
        }
        
        /* 重新设计控制区域 */
        .coord-top-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .coord-controls {
            flex: 1;
            min-width: 250px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        
        .step-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .step-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid var(--accent);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .anim-stage-container {
            flex: 2;
            min-width: 300px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        
        .anim-stage { 
            flex: 1;
            background: #fff; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            position: relative; 
            overflow: hidden; 
            margin-bottom: 15px; 
        }
        
        .axis-y { 
            position: absolute; 
            left: 0; right: 0; 
            height: 1px; 
            background: #999; 
            bottom: 40px; 
        }
        
        .axis-x { 
            position: absolute; 
            top: 0; 
            bottom: 0; 
            width: 2px; 
            background: var(--highlight); 
            left: 50%; 
            transition: left 1.2s ease-in-out; 
            z-index: 5; 
        }
        
        .point-dot { 
            position: absolute; 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            transform: translate(-50%, 50%); 
            z-index: 10; 
            transition: all 1.2s ease-in-out; 
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .point-label {
            position: absolute; 
            font-size: 13px; 
            font-weight: bold;
            background: rgba(255,255,255,0.95); 
            padding: 3px 8px; 
            border-radius: 4px;
            transform: translate(-50%, -120%); 
            z-index: 11; 
            transition: all 1.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            min-width: 80px;
            text-align: center;
        }
        
        .axis-label {
            position: absolute;
            top: 10px;
            left: 10px;
            color: var(--highlight);
            font-weight: bold;
            font-size: 12px;
            background: rgba(255,255,255,0.9);
            padding: 3px 8px;
            border-radius: 3px;
        }
        
        .scale-label {
            position: absolute;
            bottom: 10px;
            color: #999;
            font-size: 11px;
        }
        
        .scale-west {
            left: 20px;
        }
        
        .scale-east {
            right: 20px;
        }

        table.full-table { 
            width: 100%; 
            border-collapse: collapse; 
            background: #fff; 
            margin-bottom: 15px; 
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        table.full-table th, table.full-table td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: center; 
        }
        
        table.full-table th { 
            background: #f2f2f2; 
            font-weight: bold;
            color: var(--primary);
        }
        
        .coord-value {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .conclusion-footer { 
            display: block; /* 改为默认显示 */
            padding: 15px; 
            background: #eef2f5; 
            border-left: 5px solid var(--primary); 
            font-size: 0.9rem; 
            line-height: 1.6; 
            color: var(--primary);
            border-radius: 4px;
            margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* 结论部分标题样式 */
        .conclusion-title {
            font-size: 0.95rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .conclusion-title:before {
            content: "▶";
            margin-right: 8px;
            font-size: 0.8rem;
        }

    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">高斯投影教学系统</div>
    <button class="nav-btn active" onclick="switchPanel(0)">1. 投影变形规律</button>
    <button class="nav-btn" onclick="switchPanel(1)">2. 分带计算与对齐</button>
    <button class="nav-btn" onclick="switchPanel(2)">3. 坐标平移演示</button>
</div>

<div class="main">

    <!-- 面板1：投影变形 -->
    <div id="panel-1" class="panel active">
        <div class="header">
            <div>
                <div class="course-info">
                    <div class="competition-info">第六届教师教学创新大赛-人工智能组</div>
                    <div>
                        授课教师：刘佳丽 | 
                        课程：<span>测量与地图学</span> | 
                        章节：<span>第二章 第三节 高斯-克吕格投影</span>
                    </div>
                </div>
                <div>高斯投影：变形规律与等角性</div>
            </div>
        </div>
        <div class="split-container">
            <!-- 画布 -->
            <div class="canvas-box" id="canvas-container">
                <canvas id="projCanvas"></canvas>
                <div style="position:absolute; bottom:10px; left:10px; font-size:12px; color:#666; background:rgba(255,255,255,0.7); padding:5px; border-radius:4px;">
                    * 红色线为中央经线 | 注意观察：纬线为<strong>凹向两极</strong>的曲线
                </div>
            </div>

            <!-- 右侧控制 -->
            <div class="side-panel">
                <div style="margin-bottom:20px; padding:10px; background:#f0f0f0; border-radius:4px;">
                    <strong>实时参数：</strong>
                    <div style="margin-top:5px;">纬度(B): <span id="val-lat">0</span>°</div>
                    <div>经差(l): <span id="val-l">0</span>°</div>
                    <div style="font-size:1.1em; color:red; font-weight:bold; margin-top:5px;">
                        变形系数 k ≈ <span id="val-k">1.000</span>
                    </div>
                </div>

                <strong style="display:block; margin-bottom:10px;">课堂互动结论：</strong>
                
                <button class="btn btn-outline" onclick="toggleDisplay('conc-1')">▶ 点击显示：等角投影规律</button>
                <div id="conc-1" class="conclusion-box">
                    <strong>1. 形状不变 (等角性)：</strong><br>
                    请观察图上的橙色的变形椭圆。<br>
                    无论在哪里，它们在局部始终保持<strong>正圆形</strong><br>
                    这说明高斯投影保持角度不变，形状相似。<br>
                    <br>
                    <strong>2. 面积必然变形：</strong><br>
                    虽然变形椭圆形状是正圆形，但圆的<strong>大小（面积）</strong>在不同位置差异巨大。<br>
                </div>

                <button class="btn btn-outline" onclick="toggleDisplay('conc-2')">▶ 点击显示：变形分布规律</button>
                <div id="conc-2" class="conclusion-box">
                    <strong>1. 中央经线无变形：</strong><br>
                    在中央经线（红线）上，k=1，长度和面积均无变形。<br><br>
                    <strong>2. 随位置变化规律：</strong><br>
                    (1) <strong>经差越大</strong> (离红线越远)，k 越大，面积变形越大。<br>
                    (2) <strong>纬度越低</strong> (越靠近赤道)，变形越大。<br>
                    (3) <strong>纬度越高</strong> (越靠近两极)，变形越小。<br>
                    ★ <strong>最大变形</strong>发生在<strong>赤道边缘</strong>处。
                </div>
            </div>
        </div>
    </div>

    <!-- 面板2：分带计算 -->
    <div id="panel-2" class="panel">
        <div class="header">
            <div>
                <div class="course-info">
                    <div class="competition-info">第六届教师教学创新大赛-人工智能组</div>
                    <div>
                        授课教师：刘佳丽 | 
                        课程：<span>测量与地图学</span> | 
                        章节：<span>第二章 第三节 高斯-克吕格投影</span>
                    </div>
                </div>
                <div>分带计算：6度带与3度带对齐演示</div>
            </div>
        </div>
        <div class="calc-container">
            <div class="theory-box">
                <strong>分带投影基本概念：</strong><br>
                1. <strong>6°分带法</strong>：从零子午线起，由西向东，每6°为一带，全球共分60带，用阿拉伯数字1-60标记，凡是6°的整倍数的经线皆为分带子午线。<br>
                2. <strong>3°分带法</strong>：从东经1°30′起，每3°为一带，将全球划分为120带，用阿拉伯数字1-120标记。<br>
                3. <strong>对齐目的</strong>：使6°带的中央经线全部为3°带的中央经线，即3°带中有半数的中央经线同6°带的中央经线重合，以便在由3°带转换成6°带时，不需任何计算，而直接转用。
            </div>

            <!-- 计算公式与结果（移到上方） -->
            <div class="formula-container">
                <div style="text-align:center; margin-bottom:15px;">
                    <button class="btn" style="background:var(--highlight)" onclick="toggleDisplay('formula-area')">点击显示：高斯投影分带计算公式 </button>
                </div>

                <div id="formula-area" class="formula-panel">
                    <div style="margin-bottom:15px;">
                        <h3 style="margin-top:0; color:var(--primary);">计算公式 (东经 L):</h3>
                        
                        <div class="formula-row">
                            <div class="formula-label">6度带带号 (东半球):</div>
                            <div class="formula-equation">N = Int(L / 6) + 1</div>
                            <div class="formula-result" id="calc-n6">-</div>
                        </div>
                        
                        <div class="formula-row">
                            <div class="formula-label">6度带中央经线:</div>
                            <div class="formula-equation">L₀ = 6 × N - 3</div>
                            <div class="formula-result" id="calc-cm6">-</div>
                        </div>
                        
                        <div class="formula-row">
                            <div class="formula-label">3度带带号 (东半球):</div>
                            <div class="formula-equation">n = Int((L - 1.5) / 3) + 1</div>
                            <div class="formula-result" id="calc-n3">-</div>
                        </div>
                        
                        <div class="formula-row">
                            <div class="formula-label">3度带中央经线:</div>
                            <div class="formula-equation">L₀ = 3 × n</div>
                            <div class="formula-result" id="calc-cm3">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <strong>输入经度 (L):</strong>
                <input type="number" id="input-lon" value="116.4" step="0.1" placeholder="如 116.4" min="0" max="180">
                <span style="margin-right:20px">°E</span>
                <button class="btn" onclick="jumpToZone()">跳转并居中</button>
                
                <div class="control-buttons">
                    <strong style="margin-right:10px;">显示控制：</strong>
                    <button class="zone-btn active" id="btn-show-6" onclick="toggleDivisionLines(6)">显示6度带子午线</button>
                    <button class="zone-btn active" id="btn-show-3" onclick="toggleDivisionLines(3)">显示3度带子午线</button>
                </div>
            </div>

            <!-- 轨道视图 -->
            <div class="track-display">
                <!-- 中央基准 -->
                <div class="center-line-dashed"></div>
                <div class="center-label">当前经度</div>

                <div style="position:absolute; top:10px; left:10px; font-weight:bold; color:#e74c3c;">6度带</div>
                <div id="track-6" class="track-lane" style="top:35px;"></div>

                <div style="position:absolute; top:160px; left:10px; font-weight:bold; color:#27ae60;">3度带</div>
                <div id="track-3" class="track-lane" style="top:185px;"></div>
                
                <!-- 分带子午线将在此动态生成 -->
                <div id="division-lines-container"></div>
            </div>
        </div>
    </div>

    <!-- 面板3：坐标平移 -->
    <div id="panel-3" class="panel">
        <div class="header">
            <div>
                <div class="course-info">
                    <div class="competition-info">第六届教师教学创新大赛-人工智能组</div>
                    <div>
                        授课教师：刘佳丽 | 
                        课程：<span>测量与地图学</span> | 
                        章节：<span>第二章 第三节 高斯-克吕格投影</span>
                    </div>
                </div>
                <div>坐标平移 (Y值转正演示)</div>
            </div>
        </div>
        <div class="coord-layout">
            <!-- 顶部区域：控制按钮和动画区域并排 -->
            <div class="coord-top-section">
                <!-- 左侧：控制按钮和说明 -->
                <div class="coord-controls">
                    <h3 style="margin-top:0; margin-bottom:15px; color:var(--primary);">演示步骤控制</h3>
                    
                    <div class="step-buttons">
                        <button class="btn" onclick="setStep(0)" style="background:#27ae60;">步骤1: 显示原始值</button>
                        <button class="btn" onclick="setStep(1)" style="background:#2980b9;">步骤2: 纵轴西移 (+500km)</button>
                        <button class="btn" onclick="setStep(2)" style="background:#9b59b6;">步骤3: 生成通用坐标</button>
                        <button class="btn" style="background:#7f8c8d; margin-top:10px;" onclick="setStep(-1)">重置演示</button>
                    </div>
                    
                    <div class="step-info">
                        <strong>演示说明：</strong><br>
                        1. <strong>原始值</strong>：显示点A和点B的原始坐标<br>
                        2. <strong>纵轴西移</strong>：将中央经线西移500km，使所有Y值为正<br>
                        3. <strong>通用坐标</strong>：添加带号，形成完整的通用坐标
                    </div>
                </div>
                
                <!-- 右侧：动画演示区域 -->
                <div class="anim-stage-container">
                    <h3 style="margin-top:0; margin-bottom:15px; color:var(--primary);">坐标平移可视化</h3>
                    
                    <div class="anim-stage">
                        <!-- 轴 -->
                        <div class="axis-y">
                            <div style="position:absolute; right:10px; bottom:5px; color:#666; font-size:12px;">赤道 (X轴)</div>
                        </div>
                        <div id="anim-axis-x" class="axis-x">
                            <div style="position:absolute; top:10px; left:5px; color:var(--highlight); font-weight:bold; white-space:nowrap;">
                                中央经线<br><span id="axis-label" style="background:#fff;">Y=0</span>
                            </div>
                        </div>
                        
                        <!-- 标尺 -->
                        <div class="scale-label scale-west">西 (-Y)</div>
                        <div class="scale-label scale-east">东 (+Y)</div>

                        <!-- 点A -->
                        <div id="pt-a" class="point-dot" style="background:#27ae60; left:65%; bottom:70%;"></div>
                        <div id="lbl-a" class="point-label" style="left:65%; bottom:70%; color:#27ae60;">A</div>

                        <!-- 点B -->
                        <div id="pt-b" class="point-dot" style="background:#8e44ad; left:35%; bottom:60%;"></div>
                        <div id="lbl-b" class="point-label" style="left:35%; bottom:60%; color:#8e44ad;">B</div>
                        
                        <!-- 轴标签 -->
                        <div class="axis-label">Y轴 (横坐标)</div>
                    </div>
                    
                    <div style="font-size:12px; color:#666; text-align:center; margin-top:10px;">
                        * 点A: 位于中央经线以东，Y值为正 | 点B: 位于中央经线以西，Y值为负
                    </div>
                </div>
            </div>
            
            <!-- 中部：坐标表格 -->
            <div style="margin-bottom:15px;">
                <h3 style="margin-top:0; margin-bottom:15px; color:var(--primary);">坐标变换过程</h3>
                <table class="full-table">
                    <thead>
                        <tr>
                            <th width="10%">点号</th>
                            <th width="20%">X坐标 (北, m)</th>
                            <th width="20%">1. 原始自然值 Y</th>
                            <th width="25%">2. 平移后 Y' (+500km)</th>
                            <th width="25%">3. 通用坐标 Y (带号17)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>A</strong></td>
                            <td>3,500,000.0</td>
                            <td style="color:#27ae60" class="coord-value">152,863.7</td>
                            <td id="td-shift-a" class="coord-value">-</td>
                            <td id="td-gen-a" class="coord-value" style="color:var(--primary)">-</td>
                        </tr>
                        <tr>
                            <td><strong>B</strong></td>
                            <td>3,200,000.0</td>
                            <td style="color:red" class="coord-value">-148,474.8</td>
                            <td id="td-shift-b" class="coord-value">-</td>
                            <td id="td-gen-b" class="coord-value" style="color:var(--primary)">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 底部：结论 -->
            <div class="conclusion-footer">
                <div class="conclusion-title">高斯平面直角坐标系的通用横坐标</div>
                • 在高斯-克吕格投影中，以中央经线为纵轴（X轴），赤道为横轴（Y轴）<br>
                • 为避免Y坐标出现负值，将所有Y坐标统一加上500km（500,000米）<br>
                • 在平移后的Y值前冠以带号，形成完整的通用坐标<br>
                • 计算公式：Y<sub>通用</sub> = 带号(Y<sub>实际</sub> + 500,000)
            </div>
        </div>
    </div>

</div>

<script>
    // --- 导航 ---
    function switchPanel(idx) {
        document.querySelectorAll('.panel').forEach((p, i) => p.classList.toggle('active', i===idx));
        document.querySelectorAll('.nav-btn').forEach((b, i) => b.classList.toggle('active', i===idx));
        if(idx === 0) setTimeout(initCanvas, 100);
        if(idx === 1) setTimeout(() => {
            jumpToZone();
            updateCalculations();
        }, 100);
    }
    function toggleDisplay(id) {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    // ================= 功能1：投影变形 (曲线修正版) =================
    const canvas = document.getElementById('projCanvas');
    const ctx = canvas.getContext('2d');
    let cw, ch;

    function initCanvas() {
        const box = document.getElementById('canvas-container');
        cw = box.clientWidth;
        ch = box.clientHeight;
        canvas.width = cw;
        canvas.height = ch;
        drawGrid();
    }

    // 重写 project 函数：模拟高斯投影经纬网特征
    function project(lat, lonDiff) {
        const scale = ch / 180;
        const cx = cw / 2;
        const cy = ch / 2;
        
        // 角度转弧度
        const radLat = lat * Math.PI / 180;
        
        // 1. 模拟经线收敛: 经差(l) * cos(B)
        const x_pos = (lonDiff * Math.cos(radLat)) * 30; // 30为放大系数以便观察
        
        // 2. 模拟纬线弯曲 (凹向两极): 
        // 在北半球 (lat > 0), 随着 |lonDiff| 增大, 地图上的北坐标(N)增大，
        // 在屏幕坐标系中(Y向下为正), 意味着 y_scr 减小。
        // 近似公式项: l^2 * sin(B) * cos(B)
        const curveFactor = Math.pow(lonDiff, 2) * Math.sin(radLat) * Math.cos(radLat) * 0.5;
        
        const y_pos = lat + curveFactor * 10; // 放大弯曲程度
        
        const x_scr = cx + x_pos * scale;
        const y_scr = cy - y_pos * scale;
        
        return {x: x_scr, y: y_scr};
    }

    function calculateDistortion(lat, lonDiff) {
        const rad = lat * Math.PI / 180;
        const latFactor = Math.pow(Math.cos(rad), 2);
        const lonFactor = Math.pow(lonDiff, 2);
        
        const k = 1 + lonFactor * latFactor * 0.2;
        return k;
    }

    function drawGrid() {
        ctx.clearRect(0,0,cw,ch);

        // 1. 经线 (Meridians)
        ctx.lineWidth = 1;
        for(let l=-6; l<=6; l+=2) {
            ctx.beginPath();
            ctx.strokeStyle = (l===0) ? '#c0392b' : '#ddd';
            ctx.lineWidth = (l===0) ? 2 : 1;
            // 增加采样点以绘制平滑曲线
            for(let p=-85; p<=85; p+=1) {
                const pt = project(p, l);
                if(p===-85) ctx.moveTo(pt.x, pt.y); else ctx.lineTo(pt.x, pt.y);
            }
            ctx.stroke();
        }

        // 2. 纬线 (Parallels)
        ctx.strokeStyle = '#eee';
        ctx.lineWidth = 1;
        for(let p=-80; p<=80; p+=10) {
            ctx.beginPath();
            if(p===0) ctx.strokeStyle = '#2980b9'; // 赤道
            // 增加采样点以绘制平滑曲线 (体现凹向两极)
            for(let l=-6; l<=6; l+=0.1) {
                const pt = project(p, l);
                if(l===-6) ctx.moveTo(pt.x, pt.y); else ctx.lineTo(pt.x, pt.y);
            }
            ctx.stroke();
            if(p===0) ctx.strokeStyle = '#eee';
        }

        // 3. 变形椭圆
        ctx.fillStyle = "rgba(230, 126, 34, 0.5)";
        ctx.strokeStyle = "#d35400";
        
        for(let l=-4; l<=4; l+=2) {
            for(let p=-60; p<=60; p+=15) {
                const pt = project(p, l);
                const k = calculateDistortion(p, l);
                
                const radius = 5 * k;
                
                ctx.beginPath();
                ctx.arc(pt.x, pt.y, radius, 0, Math.PI*2);
                ctx.fill();
                ctx.stroke();
                
                if(Math.abs(p) < 5) {
                    ctx.fillStyle = "rgba(231, 76, 60, 0.3)";
                    ctx.beginPath();
                    ctx.arc(pt.x, pt.y, radius, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = "rgba(230, 126, 34, 0.5)";
                }
            }
        }
        
        // 4. 添加图例说明
        ctx.fillStyle = "#333";
        ctx.font = "12px Arial";
        ctx.fillText("纬线特征：凹向两极", 20, 30);
        ctx.fillText("经线特征：收敛于极", 20, 50);
    }

    canvas.addEventListener('mousemove', (e) => {
        const r = canvas.getBoundingClientRect();
        // 简单反算仅用于显示近似值
        const scale = ch / 180;
        const cy = ch / 2;
        const lat = -(e.clientY - r.top - cy) / scale;
        
        const rad = lat * Math.PI / 180;
        let cos = Math.cos(rad);
        if(Math.abs(cos) < 0.1) cos=0.1;
        const cx = cw / 2;
        const mx = e.clientX - r.left;
        const l = (mx - cx) / (scale * 30 * cos);

        const k = calculateDistortion(lat, l);

        document.getElementById('val-k').innerText = k.toFixed(3);
        document.getElementById('val-l').innerText = Math.abs(l).toFixed(1);
        document.getElementById('val-lat').innerText = lat.toFixed(0);
    });
    
    window.addEventListener('resize', () => { 
        if(document.querySelector('#panel-1').classList.contains('active')) initCanvas(); 
    });

    // ================= 功能2：分带计算 (添加带号) =================
    const pxPerDeg = 28; // 比例尺：1度 = 28px
    let show6Divisions = true;
    let show3Divisions = true;

    // 切换分带子午线显示
    function toggleDivisionLines(type) {
        if (type === 6) {
            show6Divisions = !show6Divisions;
            document.getElementById('btn-show-6').classList.toggle('active', show6Divisions);
        } else {
            show3Divisions = !show3Divisions;
            document.getElementById('btn-show-3').classList.toggle('active', show3Divisions);
        }
        drawDivisionLines(); // 重新绘制分带子午线
    }

    // 绘制分带子午线
    function drawDivisionLines() {
        const container = document.getElementById('division-lines-container');
        container.innerHTML = '';
        
        const trackDisplay = container.parentElement;
        const boxWidth = trackDisplay.clientWidth;
        const centerPx = boxWidth / 2;
        const lon = parseFloat(document.getElementById('input-lon').value) || 116.4;
        
        // 计算显示范围（当前经度前后30度）
        const startLon = lon - 30;
        const endLon = lon + 30;
        
        // 6度带子午线 (中央经线位置)
        if (show6Divisions) {
            for (let n = 1; n <= 30; n++) {
                const cmLon6 = 6 * n - 3; // 6度带中央经线公式
                
                // 只显示在可视范围内的子午线
                if (cmLon6 >= startLon && cmLon6 <= endLon) {
                    const leftPos = centerPx + (cmLon6 - lon) * pxPerDeg;
                    
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'division-line-6';
                    lineDiv.style.left = leftPos + 'px';
                    lineDiv.title = `6°带第${n}带中央经线: ${cmLon6}°`;
                    container.appendChild(lineDiv);
                    
                    // 添加标签
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'division-label';
                    labelDiv.style.left = leftPos + 'px';
                    labelDiv.style.top = '45px';
                    labelDiv.style.background = '#e74c3c';
                    labelDiv.style.fontSize = '10px';
                    labelDiv.style.padding = '2px 4px';
                    labelDiv.innerText = `${cmLon6}°`;
                    container.appendChild(labelDiv);
                }
            }
        }
        
        // 3度带子午线 (中央经线位置)
        if (show3Divisions) {
            for (let n = 1; n <= 60; n++) {
                const cmLon3 = 3 * n; // 3度带中央经线公式
                
                // 只显示在可视范围内的子午线
                if (cmLon3 >= startLon && cmLon3 <= endLon) {
                    const leftPos = centerPx + (cmLon3 - lon) * pxPerDeg;
                    
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'division-line-3';
                    lineDiv.style.left = leftPos + 'px';
                    lineDiv.title = `3°带第${n}带中央经线: ${cmLon3}°`;
                    container.appendChild(lineDiv);
                    
                    // 每隔一个带添加标签，避免过于密集
                    if (n % 2 === 0) {
                        const labelDiv = document.createElement('div');
                        labelDiv.className = 'division-label';
                        labelDiv.style.left = leftPos + 'px';
                        labelDiv.style.top = '210px';
                        labelDiv.style.background = '#27ae60';
                        labelDiv.style.fontSize = '10px';
                        labelDiv.style.padding = '2px 4px';
                        labelDiv.innerText = `${cmLon3}°`;
                        container.appendChild(labelDiv);
                    }
                }
            }
        }
        
        // 如果容器宽度不足以显示所有内容，调整容器宽度
        const requiredWidth = Math.max(
            (lon - startLon) * pxPerDeg * 2,
            (endLon - lon) * pxPerDeg * 2,
            boxWidth
        );
        
        if (requiredWidth > boxWidth) {
            trackDisplay.style.width = requiredWidth + 'px';
        }
    }

    // 更新计算结果显示
    function updateCalculations() {
        const lon = parseFloat(document.getElementById('input-lon').value) || 116.4;
        
        // 计算6度带
        const n6 = Math.floor(lon/6) + 1;
        const cm6 = 6 * n6 - 3;
        
        // 计算3度带
        const n3 = Math.floor((lon - 1.5) / 3) + 1;
        const cm3 = 3 * n3;
        
        // 更新公式结果
        document.getElementById('calc-n6').innerText = n6;
        document.getElementById('calc-cm6').innerText = cm6 + "°";
        document.getElementById('calc-n3').innerText = n3;
        document.getElementById('calc-cm3').innerText = cm3 + "°";
    }

    function jumpToZone() {
        const lonInput = document.getElementById('input-lon');
        let lon = parseFloat(lonInput.value);
        
        if(isNaN(lon)) {
            lon = 116.4;
            lonInput.value = lon;
        }
        
        // 限制经度范围
        if(lon < 0) lon = 0;
        if(lon > 180) lon = 180;
        
        // 更新计算结果
        updateCalculations();
        
        // 重新绘制分带和子午线
        drawZones(lon);
        drawDivisionLines();
    }

    function drawZones(centerLon) {
        const track6 = document.getElementById('track-6');
        const track3 = document.getElementById('track-3');
        track6.innerHTML = '';
        track3.innerHTML = '';
        
        const trackDisplay = track6.parentElement;
        const boxWidth = trackDisplay.clientWidth;
        const centerPx = boxWidth / 2;
        
        // 更新中央经线标签
        const centerLabel = document.querySelector('.center-label');
        if (centerLabel) {
            centerLabel.innerText = `当前: ${centerLon.toFixed(1)}°`;
        }
        
        // 计算显示范围（当前经度前后30度）
        const startLon = centerLon - 30;
        const endLon = centerLon + 30;
        
        // 6度带绘制
        for(let i = -3; i <= 3; i++) {
            const zoneNum6 = Math.floor(centerLon/6) + 1 + i;
            if(zoneNum6 < 1 || zoneNum6 > 30) continue;
            
            const startLon6 = (zoneNum6 - 1) * 6;
            const endLon6 = zoneNum6 * 6;
            const cmLon6 = startLon6 + 3;
            
            // 只显示在可视范围内的带
            if (cmLon6 >= startLon && cmLon6 <= endLon) {
                // 计算位置
                const blockWidth6 = 6 * pxPerDeg;
                const leftPos6 = centerPx + (cmLon6 - centerLon) * pxPerDeg - blockWidth6/2;
                
                const div6 = document.createElement('div');
                div6.className = 'zone-block';
                div6.style.width = blockWidth6 + 'px';
                div6.style.left = leftPos6 + 'px';
                div6.style.background = '#f0f7ff';
                
                if(centerLon >= startLon6 && centerLon < endLon6) {
                    div6.classList.add('active');
                }
                
                // 修改：添加醒目的 zone-number-large (带号)
                div6.innerHTML = `
                    <div style="font-size:16px; font-weight:bold; color:#2c3e50; margin-bottom:2px;">${zoneNum6}</div>
                    <span style="font-weight:bold; color:#e74c3c;">6度带</span>
                    <span style="color:#666; font-size:11px;">${startLon6}°~${endLon6}°</span>
                    <span style="color:#2980b9; font-weight:bold; font-size:11px;">CM ${cmLon6}°</span>
                `;
                div6.onclick = () => {
                    document.getElementById('input-lon').value = cmLon6;
                    jumpToZone();
                };
                track6.appendChild(div6);
            }
        }
        
        // 3度带绘制
        for(let i = -6; i <= 6; i++) {
            const zoneNum3 = Math.floor((centerLon - 1.5) / 3) + 1 + i;
            if(zoneNum3 < 1 || zoneNum3 > 60) continue;
            
            const startLon3 = 1.5 + (zoneNum3 - 1) * 3;
            const endLon3 = startLon3 + 3;
            const cmLon3 = 3 * zoneNum3;
            
            // 只显示在可视范围内的带
            if (cmLon3 >= startLon && cmLon3 <= endLon) {
                // 计算位置
                const blockWidth3 = 3 * pxPerDeg;
                const leftPos3 = centerPx + (cmLon3 - centerLon) * pxPerDeg - blockWidth3/2;
                
                const div3 = document.createElement('div');
                div3.className = 'zone-block';
                div3.style.width = blockWidth3 + 'px';
                div3.style.left = leftPos3 + 'px';
                div3.style.background = '#f0fff0';
                
                if(centerLon >= startLon3 && centerLon < endLon3) {
                    div3.classList.add('active');
                }
                
                // 修改：添加醒目的 zone-number-large (带号)
                div3.innerHTML = `
                    <div style="font-size:16px; font-weight:bold; color:#27ae60; margin-bottom:2px;">${zoneNum3}</div>
                    <span style="font-weight:bold; color:#27ae60;">3度带</span>
                    <span style="color:#666; font-size:11px;">${startLon3.toFixed(1)}°~${endLon3.toFixed(1)}°</span>
                    <span style="color:#2980b9; font-weight:bold; font-size:11px;">CM ${cmLon3}°</span>
                `;
                div3.onclick = () => {
                    document.getElementById('input-lon').value = cmLon3;
                    jumpToZone();
                };
                track3.appendChild(div3);
            }
        }
        
        // 调整容器宽度以适应内容
        const requiredWidth = Math.max(
            (centerLon - startLon) * pxPerDeg * 2,
            (endLon - centerLon) * pxPerDeg * 2,
            boxWidth
        );
        
        if (requiredWidth > boxWidth) {
            trackDisplay.style.width = requiredWidth + 'px';
        }
    }

    // ================= 功能3：坐标平移 =================
    const rawA = 152863.7;
    const rawB = -148474.8;
    const shift = 500000;
    const zone = 17;

    function setStep(step) {
        const axis = document.getElementById('anim-axis-x');
        const ptA = document.getElementById('pt-a');
        const ptB = document.getElementById('pt-b');
        const lblA = document.getElementById('lbl-a');
        const lblB = document.getElementById('lbl-b');

        // Reset text
        document.getElementById('td-shift-a').innerText = "-";
        document.getElementById('td-shift-b').innerText = "-";
        document.getElementById('td-gen-a').innerText = "-";
        document.getElementById('td-gen-b').innerText = "-";

        // 初始位置
        if(step === -1 || step === 0) {
            axis.style.left = "50%";
            
            ptA.style.left = "65.2%";
            ptB.style.left = "35.2%";
            
            lblA.innerText = "A";
            lblB.innerText = "B";
        }

        if(step >= 1) {
            const sa = rawA + shift;
            const sb = rawB + shift;
            document.getElementById('td-shift-a').innerText = sa.toLocaleString();
            document.getElementById('td-shift-b').innerText = sb.toLocaleString();
            
            // 动画轴左移
            axis.style.left = "10%";
            
            lblA.innerText = "Y'=" + sa.toLocaleString();
            lblB.innerText = "Y'=" + sb.toLocaleString();
        }

        if(step >= 2) {
            const ga = zone + " " + (rawA+shift).toLocaleString();
            const gb = zone + " " + (rawB+shift).toLocaleString();
            
            document.getElementById('td-gen-a').innerText = ga;
            document.getElementById('td-gen-b').innerText = gb;
            
            lblA.innerText = "Y=" + ga;
            lblB.innerText = "Y=" + gb;
        }
    }
    
    // 初始化
    initCanvas();
    setStep(0);

</script>
</body>
</html>