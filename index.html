<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>《测量与地图学》小组汇报评分系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SheetJS库用于Excel导出 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        h1 i {
            font-size: 32px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .chapter-info {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 15px;
            color: #2c3e50;
            border-left: 4px solid #3498db;
        }
        
        .content-area {
            display: flex;
            flex-wrap: wrap;
            padding: 25px;
            gap: 25px;
        }
        
        .scoring-section {
            flex: 1;
            min-width: 350px;
            background-color: #f9fbfd;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .results-section {
            flex: 2;
            min-width: 350px;
            background-color: #f9fbfd;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #3498db;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d9e6;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.3s;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .criteria-item {
            background-color: white;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 18px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }
        
        .criteria-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .criteria-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .max-score {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .score-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .score-input input {
            width: 80px;
            text-align: center;
        }
        
        .score-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #dfe6e9;
            border-radius: 3px;
            outline: none;
        }
        
        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .total-score {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-top: 25px;
        }
        
        .total-score-value {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
            color: #3498db;
        }
        
        .submit-btn {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            background: linear-gradient(to right, #2980b9, #1f639e);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .results-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .results-table td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .results-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .results-table tr:hover {
            background-color: #e8f4fc;
        }
        
        .final-score {
            font-weight: 700;
            color: #2c3e50;
        }
        
        .average-display {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            text-align: center;
        }
        
        .average-value {
            font-size: 36px;
            font-weight: 700;
            margin: 10px 0;
            color: #2ecc71;
        }
        
        .instructions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid #f39c12;
        }
        
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .group-input-area {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }
        
        .group-input {
            flex: 1;
        }
        
        .group-select-btn {
            padding: 12px 25px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .group-select-btn:hover {
            background-color: #2980b9;
        }
        
        .vote-stats {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        
        .vote-stats h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .vote-count {
            font-size: 36px;
            font-weight: 700;
            color: #3498db;
            margin: 10px 0;
        }
        
        .named-vote-notice {
            background-color: #d5edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #155724;
        }
        
        .data-management {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
            border-left: 4px solid #9b59b6;
        }
        
        .data-management h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .data-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .data-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .export-btn {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
        }
        
        .export-btn:hover {
            background: linear-gradient(to right, #27ae60, #219653);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        .import-btn {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }
        
        .import-btn:hover {
            background: linear-gradient(to right, #2980b9, #1f639e);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .clear-btn {
            background: linear-gradient(to right, #e74c3c, #c0392b);
            color: white;
        }
        
        .clear-btn:hover {
            background: linear-gradient(to right, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        @media (max-width: 768px) {
            .content-area {
                flex-direction: column;
                padding: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .group-input-area {
                flex-direction: column;
                align-items: stretch;
            }
            
            .data-buttons {
                grid-template-columns: 1fr;
            }
            
            .results-table {
                font-size: 12px;
            }
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        
        .current-group-display {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            display: inline-block;
            font-weight: 600;
            margin-bottom: 20px;
        }
        
        .refresh-btn {
            background: linear-gradient(to right, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: linear-gradient(to right, #e67e22, #d35400);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        
        .file-input {
            display: none;
        }
        
        .comment-cell {
            max-width: 200px;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        .summary-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #f39c12;
        }
        
        .summary-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .summary-textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .group-select-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .group-select {
            flex: 1;
        }
        
        .current-group {
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #555;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background-color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marked-alt"></i> 《测量与地图学》小组汇报评分系统</h1>
            <p class="subtitle">第十六章第五节：地图学应用 - 记名评分系统</p>
            <div class="chapter-info">
                <p><i class="fas fa-info-circle"></i> 请根据评分标准为各小组的课堂展示进行评分。所有评分数据将自动保存并可以导出为Excel格式。</p>
            </div>
        </header>
        
        <div class="content-area">
            <div class="scoring-section">
                <div class="tab-container">
                    <button class="tab active" data-tab="scoring">评分</button>
                    <button class="tab" data-tab="management">数据管理</button>
                </div>
                
                <div id="scoring" class="tab-content active">
                    <h2 class="section-title"><i class="fas fa-edit"></i> 评分区域</h2>
                    
                    <div class="named-vote-notice">
                        <i class="fas fa-user-check"></i> 本评分系统采用<strong>记名投票</strong>方式，将记录评分人信息。
                    </div>
                    
                    <div class="form-group">
                        <label for="reviewerName"><i class="fas fa-user"></i> 评分人姓名</label>
                        <input type="text" id="reviewerName" placeholder="请输入您的姓名">
                    </div>
                    
                    <div class="form-group">
                        <label for="groupSelect"><i class="fas fa-users"></i> 选择汇报小组</label>
                        <select id="groupSelect" class="group-select">
                            <option value="">请选择小组</option>
                            <!-- 1-20组将通过JavaScript动态生成 -->
                        </select>
                    </div>
                    
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-name">基本素质 (20分)</span>
                            <span class="max-score">满分: 20分</span>
                        </div>
                        <p style="font-size: 14px; color: #555; margin-bottom: 12px;">仪表整洁、教态大方、亲切、有感染力，精神饱满、能较好的运用动作、手势表达对讲稿的理解。普通话标准，语言准确、生动、精炼、流畅；板书规范，设计合理；熟练恰当使用现代教育技术手段。</p>
                        <div class="score-input">
                            <input type="number" id="basicScore" min="0" max="20" value="0" class="score-number">
                            <input type="range" min="0" max="20" value="0" class="score-slider" data-target="basicScore">
                        </div>
                    </div>
                    
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-name">演讲内容 (30分)</span>
                            <span class="max-score">满分: 30分</span>
                        </div>
                        <p style="font-size: 14px; color: #555; margin-bottom: 12px;">深入研读教材等参考资料，展示内容选取合理；体现教学内容的整体性和关联性；展示内容丰富、完整，具有前沿性和创新性，具有典型理论与案例相结合的分析。</p>
                        <div class="score-input">
                            <input type="number" id="contentScore" min="0" max="30" value="0" class="score-number">
                            <input type="range" min="0" max="30" value="0" class="score-slider" data-target="contentScore">
                        </div>
                    </div>
                    
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-name">展示过程 (30分)</span>
                            <span class="max-score">满分: 30分</span>
                        </div>
                        <p style="font-size: 14px; color: #555; margin-bottom: 12px;">小组分工明确，组员全程参与，展示过程结构严谨，层次清晰，过渡合理，自然流畅，时间把握较好。具有较好的应变及驾驭教材等参考资料和课堂的能力；以学生为主体，学生参与度高，课堂民主和谐，善于营造轻松愉快的课堂氛围。</p>
                        <div class="score-input">
                            <input type="number" id="processScore" min="0" max="30" value="0" class="score-number">
                            <input type="range" min="0" max="30" value="0" class="score-slider" data-target="processScore">
                        </div>
                    </div>
                    
                    <div class="criteria-item">
                        <div class="criteria-header">
                            <span class="criteria-name">课件制作 (20分)</span>
                            <span class="max-score">满分: 20分</span>
                        </div>
                        <p style="font-size: 14px; color: #555; margin-bottom: 12px;">内容完整清晰，有代表性、真实有效、新颖，能准确地表达内容，重点突出。课件的设计新颖，具有较强的创新性，有趣味性；讲稿完整，语句通顺，格式规范。合理使用了文本、图片、表格、图表、图形、动画、动作等表现工具。</p>
                        <div class="score-input">
                            <input type="number" id="presentationScore" min="0" max="20" value="0" class="score-number">
                            <input type="range" min="0" max="20" value="0" class="score-slider" data-target="presentationScore">
                        </div>
                    </div>
                    
                    <div class="summary-section">
                        <h4><i class="fas fa-comment"></i> 总评语</h4>
                        <textarea id="overallComment" class="summary-textarea" placeholder="请撰写对小组汇报的总评语（选填）"></textarea>
                    </div>
                    
                    <div class="total-score">
                        <div>当前评分总分</div>
                        <div class="total-score-value" id="currentTotal">0</div>
                        <div>满分：100分</div>
                    </div>
                    
                    <button class="submit-btn" id="submitScore">
                        <i class="fas fa-paper-plane"></i> 提交评分
                    </button>
                </div>
                
                <div id="management" class="tab-content">
                    <h2 class="section-title"><i class="fas fa-database"></i> 数据管理</h2>
                    
                    <div class="data-management">
                        <h3><i class="fas fa-cogs"></i> 数据操作</h3>
                        <p>所有评分数据保存在浏览器本地存储中，可以使用以下功能管理数据：</p>
                        
                        <div class="data-buttons">
                            <button class="data-btn export-btn" id="exportExcel">
                                <i class="fas fa-file-excel"></i> 导出为Excel
                            </button>
                            <button class="data-btn import-btn" id="importData">
                                <i class="fas fa-file-import"></i> 导入数据
                            </button>
                            <button class="data-btn clear-btn" id="clearData">
                                <i class="fas fa-trash-alt"></i> 清除所有数据
                            </button>
                        </div>
                        
                        <input type="file" id="importFile" accept=".json,.xlsx,.xls" class="file-input">
                        
                        <div style="margin-top: 20px; padding: 15px; background-color: #e8f4fc; border-radius: 6px;">
                            <h4><i class="fas fa-info-circle"></i> 使用说明</h4>
                            <ul style="padding-left: 20px; font-size: 14px;">
                                <li><strong>导出Excel：</strong>将所有评分数据导出为Excel文件，方便统计</li>
                                <li><strong>导入数据：</strong>导入其他同学导出的数据文件，合并所有评分</li>
                                <li><strong>清除数据：</strong>清空本地所有评分记录（谨慎操作）</li>
                                <li>数据保存在浏览器本地，如需长期保存请定期导出备份</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="results-section">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> 评分结果</h2>
                
                <div class="vote-stats">
                    <h3><i class="fas fa-vote-yea"></i> 统计信息</h3>
                    <div>总评分记录：<strong id="totalRecords">0</strong> 条</div>
                    <div class="vote-count" id="voteCount">0</div>
                    <div>个小组已被评分</div>
                    <button class="refresh-btn" id="refreshResults">
                        <i class="fas fa-sync-alt"></i> 刷新结果
                    </button>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label for="filterGroup"><i class="fas fa-filter"></i> 按小组筛选：</label>
                    <select id="filterGroup" style="width: 150px; padding: 8px; border-radius: 4px;">
                        <option value="">全部小组</option>
                        <!-- 小组筛选选项将通过JavaScript动态生成 -->
                    </select>
                </div>
                
                <div style="overflow-x: auto; max-height: 500px;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>评分人</th>
                                <th>小组</th>
                                <th>基本素质</th>
                                <th>演讲内容</th>
                                <th>展示过程</th>
                                <th>课件制作</th>
                                <th>总分</th>
                                <th>总评语</th>
                                <th>时间</th>
                            </tr>
                        </thead>
                        <tbody id="scoresTable">
                            <!-- 评分记录将在这里动态生成 -->
                            <tr><td colspan="9" style="text-align: center; padding: 30px;">暂无评分记录</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="average-display">
                    <div>当前小组平均分</div>
                    <div class="average-value" id="groupAverage">0.0</div>
                    <div>基于 <span id="totalVotes">0</span> 条评分记录</div>
                </div>
                
                <div class="instructions" style="margin-top: 20px;">
                    <h3><i class="fas fa-lightbulb"></i> GitHub Pages 部署说明</h3>
                    <ul>
                        <li>将本HTML文件上传到GitHub仓库</li>
                        <li>在仓库设置中启用GitHub Pages</li>
                        <li>将生成的链接分享给全班同学</li>
                        <li>每位同学提交评分后，数据会保存在各自的浏览器中</li>
                        <li>教师可以收集所有同学的导出文件，然后导入合并</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-clipboard-check"></i> 使用说明</h3>
            <ul>
                <li>本评分系统采用<strong>记名投票</strong>方式，记录评分人信息。</li>
                <li>请先输入评分人姓名，然后选择小组进行评分。</li>
                <li>每个评分项目有相应的分值上限，请确保评分不超过上限。</li>
                <li>每位同学可以为每个小组评分一次。</li>
                <li>所有评分数据保存在浏览器本地，可使用"数据管理"功能导出、导入或清除。</li>
                <li>教师可以收集所有同学的导出数据，然后导入合并得到完整的评分结果。</li>
                <li>最终成绩将以所有评分的平均分为准。</li>
            </ul>
        </div>
        
        <footer>
            <p>《测量与地图学》小组汇报评分系统 &copy; 2023 | 第十六章第五节：地图学应用</p>
            <p>数据存储：评分数据保存在浏览器本地存储中，清空浏览器缓存将丢失数据</p>
        </footer>
    </div>

    <script>
        // 当前选中的小组
        let currentGroup = "";
        
        // 存储所有评分数据
        let allScores = [];
        
        // 初始化1-20组选项
        function initializeGroupOptions() {
            const groupSelect = document.getElementById('groupSelect');
            const filterGroup = document.getElementById('filterGroup');
            
            // 清空现有选项（除了第一个占位选项）
            while (groupSelect.options.length > 1) {
                groupSelect.remove(1);
            }
            
            while (filterGroup.options.length > 1) {
                filterGroup.remove(1);
            }
            
            // 添加1-20组选项
            for (let i = 1; i <= 20; i++) {
                const groupName = `第${i}组`;
                const option1 = document.createElement('option');
                option1.value = groupName;
                option1.textContent = groupName;
                groupSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = groupName;
                option2.textContent = groupName;
                filterGroup.appendChild(option2);
            }
        }
        
        // 从本地存储加载数据
        function loadScores() {
            const savedScores = localStorage.getItem('surveyScoringData');
            if (savedScores) {
                allScores = JSON.parse(savedScores);
                updateResultsDisplay();
            }
        }
        
        // 保存数据到本地存储
        function saveScores() {
            localStorage.setItem('surveyScoringData', JSON.stringify(allScores));
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化小组选项
            initializeGroupOptions();
            
            // 加载数据
            loadScores();
            
            // 小组选择事件
            document.getElementById('groupSelect').addEventListener('change', function() {
                currentGroup = this.value;
            });
            
            // 分数输入框与滑块的同步
            document.querySelectorAll('.score-number').forEach(input => {
                input.addEventListener('input', function() {
                    const targetId = this.id;
                    const slider = document.querySelector(`.score-slider[data-target="${targetId}"]`);
                    slider.value = this.value;
                    updateTotalScore();
                });
            });
            
            document.querySelectorAll('.score-slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    const targetId = this.dataset.target;
                    const numberInput = document.getElementById(targetId);
                    numberInput.value = this.value;
                    updateTotalScore();
                });
            });
            
            // 提交评分
            document.getElementById('submitScore').addEventListener('click', submitScore);
            
            // 刷新结果按钮
            document.getElementById('refreshResults').addEventListener('click', function() {
                loadScores();
                alert('评分结果已刷新');
            });
            
            // 导出Excel按钮
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            
            // 导入数据按钮
            document.getElementById('importData').addEventListener('click', function() {
                document.getElementById('importFile').click();
            });
            
            // 清除数据按钮
            document.getElementById('clearData').addEventListener('click', clearAllData);
            
            // 文件导入
            document.getElementById('importFile').addEventListener('change', importData);
            
            // 小组筛选
            document.getElementById('filterGroup').addEventListener('change', updateResultsDisplay);
            
            // 标签页切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // 移除所有标签的active类
                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // 隐藏所有内容
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // 激活当前标签
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // 初始更新总分
            updateTotalScore();
        });
        
        // 更新总分显示
        function updateTotalScore() {
            const basicScore = parseInt(document.getElementById('basicScore').value) || 0;
            const contentScore = parseInt(document.getElementById('contentScore').value) || 0;
            const processScore = parseInt(document.getElementById('processScore').value) || 0;
            const presentationScore = parseInt(document.getElementById('presentationScore').value) || 0;
            
            const total = basicScore + contentScore + processScore + presentationScore;
            document.getElementById('currentTotal').textContent = total;
        }
        
        // 提交评分
        function submitScore() {
            const reviewerName = document.getElementById('reviewerName').value.trim();
            currentGroup = document.getElementById('groupSelect').value;
            const overallComment = document.getElementById('overallComment').value.trim();
            
            if (!reviewerName) {
                alert('请输入评分人姓名');
                return;
            }
            
            if (!currentGroup) {
                alert('请选择小组');
                return;
            }
            
            const basicScore = parseInt(document.getElementById('basicScore').value);
            const contentScore = parseInt(document.getElementById('contentScore').value);
            const processScore = parseInt(document.getElementById('processScore').value);
            const presentationScore = parseInt(document.getElementById('presentationScore').value);
            
            // 验证输入
            if (isNaN(basicScore) || basicScore < 0 || basicScore > 20) {
                alert('请为"基本素质"项输入0-20之间的有效分数');
                return;
            }
            
            if (isNaN(contentScore) || contentScore < 0 || contentScore > 30) {
                alert('请为"演讲内容"项输入0-30之间的有效分数');
                return;
            }
            
            if (isNaN(processScore) || processScore < 0 || processScore > 30) {
                alert('请为"展示过程"项输入0-30之间的有效分数');
                return;
            }
            
            if (isNaN(presentationScore) || presentationScore < 0 || presentationScore > 20) {
                alert('请为"课件制作"项输入0-20之间的有效分数');
                return;
            }
            
            // 检查是否已经为这个小组评过分
            const existingScoreIndex = allScores.findIndex(score => 
                score.reviewer === reviewerName && score.group === currentGroup
            );
            
            if (existingScoreIndex !== -1) {
                if (!confirm(`${reviewerName}，您已经为${currentGroup}评过分，是否要覆盖之前的评分？`)) {
                    return;
                }
                // 移除之前的评分
                allScores.splice(existingScoreIndex, 1);
            }
            
            // 创建评分对象
            const scoreEntry = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                reviewer: reviewerName,
                group: currentGroup,
                basic: basicScore,
                content: contentScore,
                process: processScore,
                presentation: presentationScore,
                total: basicScore + contentScore + processScore + presentationScore,
                comment: overallComment,
                timestamp: new Date().toLocaleString()
            };
            
            // 添加到评分数组
            allScores.push(scoreEntry);
            
            // 保存到本地存储
            saveScores();
            
            // 更新结果显示
            updateResultsDisplay();
            
            // 重置表单
            resetScoringForm();
            
            alert(`评分已提交！${currentGroup}当前平均分：${calculateGroupAverage(currentGroup).toFixed(1)}`);
        }
        
        // 重置评分表单
        function resetScoringForm() {
            document.getElementById('reviewerName').value = '';
            document.getElementById('groupSelect').value = '';
            document.getElementById('basicScore').value = 0;
            document.getElementById('contentScore').value = 0;
            document.getElementById('processScore').value = 0;
            document.getElementById('presentationScore').value = 0;
            document.getElementById('overallComment').value = '';
            
            // 同步滑块
            document.querySelectorAll('.score-slider').forEach(slider => {
                const targetId = slider.dataset.target;
                document.getElementById(targetId).value = 0;
                slider.value = 0;
            });
            
            updateTotalScore();
        }
        
        // 更新结果显示
        function updateResultsDisplay() {
            const scoresTable = document.getElementById('scoresTable');
            const filterGroup = document.getElementById('filterGroup').value;
            
            // 筛选数据
            let filteredScores = allScores;
            if (filterGroup) {
                filteredScores = allScores.filter(score => score.group === filterGroup);
            }
            
            // 如果没有评分记录
            if (filteredScores.length === 0) {
                scoresTable.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 30px;">暂无评分记录</td></tr>';
                document.getElementById('groupAverage').textContent = '0.0';
                document.getElementById('totalVotes').textContent = '0';
                document.getElementById('voteCount').textContent = '0';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }
            
            // 清空表格内容
            scoresTable.innerHTML = '';
            
            // 添加评分记录
            filteredScores.forEach((score, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${score.reviewer}</td>
                    <td>${score.group}</td>
                    <td>${score.basic}</td>
                    <td>${score.content}</td>
                    <td>${score.process}</td>
                    <td>${score.presentation}</td>
                    <td class="final-score">${score.total}</td>
                    <td class="comment-cell">${score.comment || '-'}</td>
                    <td>${score.timestamp}</td>
                `;
                
                scoresTable.appendChild(row);
            });
            
            // 统计信息
            document.getElementById('totalRecords').textContent = allScores.length;
            
            // 计算不同小组数量
            const uniqueGroups = [...new Set(allScores.map(score => score.group))];
            document.getElementById('voteCount').textContent = uniqueGroups.length;
            
            // 计算当前筛选小组的平均分
            let average = 0;
            if (filterGroup) {
                average = calculateGroupAverage(filterGroup);
                document.getElementById('totalVotes').textContent = filteredScores.length;
            } else {
                // 如果没有筛选，显示所有评分的平均分
                const totalSum = allScores.reduce((sum, score) => sum + score.total, 0);
                average = allScores.length > 0 ? totalSum / allScores.length : 0;
                document.getElementById('totalVotes').textContent = allScores.length;
            }
            
            document.getElementById('groupAverage').textContent = average.toFixed(1);
        }
        
        // 计算小组平均分
        function calculateGroupAverage(groupName) {
            const groupScores = allScores.filter(score => score.group === groupName);
            
            if (groupScores.length === 0) {
                return 0;
            }
            
            const total = groupScores.reduce((sum, score) => sum + score.total, 0);
            return total / groupScores.length;
        }
        
        // 导出为Excel
        function exportToExcel() {
            if (allScores.length === 0) {
                alert('暂无评分数据可导出');
                return;
            }
            
            try {
                // 准备数据
                const excelData = allScores.map(score => ({
                    '评分人': score.reviewer,
                    '小组': score.group,
                    '基本素质': score.basic,
                    '演讲内容': score.content,
                    '展示过程': score.process,
                    '课件制作': score.presentation,
                    '总分': score.total,
                    '总评语': score.comment || '',
                    '评分时间': score.timestamp
                }));
                
                // 创建工作表
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // 创建工作簿
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "评分数据");
                
                // 生成Excel文件
                const fileName = `测量与地图学评分数据_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert(`评分数据已导出为Excel文件：${fileName}`);
            } catch (error) {
                console.error('导出Excel失败:', error);
                alert('导出失败，请重试或使用其他浏览器');
            }
        }
        
        // 导入数据
        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'json') {
                // 导入JSON文件
                importJSON(file);
            } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                // 导入Excel文件
                importExcel(file);
            } else {
                alert('请选择JSON或Excel格式的文件');
                event.target.value = '';
            }
        }
        
        // 导入JSON数据
        function importJSON(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        alert('导入失败：文件格式不正确，应为数组格式');
                        return;
                    }
                    
                    // 合并数据（避免重复）
                    const existingIds = new Set(allScores.map(score => score.id));
                    let newCount = 0;
                    
                    importedData.forEach(item => {
                        if (!existingIds.has(item.id)) {
                            allScores.push(item);
                            existingIds.add(item.id);
                            newCount++;
                        }
                    });
                    
                    // 保存数据
                    saveScores();
                    updateResultsDisplay();
                    
                    alert(`数据导入成功！新增${newCount}条记录，共${allScores.length}条记录`);
                } catch (error) {
                    alert('导入失败：文件格式不正确');
                    console.error(error);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }
        
        // 导入Excel数据
        function importExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        alert('Excel文件中没有数据');
                        return;
                    }
                    
                    // 转换为评分数据格式
                    const importedData = jsonData.map(row => {
                        // 生成唯一ID
                        const id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                        
                        return {
                            id: id,
                            reviewer: row['评分人'] || '未知',
                            group: row['小组'] || '未知小组',
                            basic: parseInt(row['基本素质']) || 0,
                            content: parseInt(row['演讲内容']) || 0,
                            process: parseInt(row['展示过程']) || 0,
                            presentation: parseInt(row['课件制作']) || 0,
                            total: parseInt(row['总分']) || 0,
                            comment: row['总评语'] || '',
                            timestamp: row['评分时间'] || new Date().toLocaleString()
                        };
                    });
                    
                    // 合并数据（避免重复）
                    const existingIds = new Set(allScores.map(score => score.id));
                    let newCount = 0;
                    
                    importedData.forEach(item => {
                        if (!existingIds.has(item.id)) {
                            allScores.push(item);
                            existingIds.add(item.id);
                            newCount++;
                        }
                    });
                    
                    // 保存数据
                    saveScores();
                    updateResultsDisplay();
                    
                    alert(`Excel数据导入成功！新增${newCount}条记录，共${allScores.length}条记录`);
                } catch (error) {
                    alert('导入Excel失败：文件格式不正确');
                    console.error(error);
                }
                event.target.value = '';
            };
            reader.readAsArrayBuffer(file);
        }
        
        // 清除所有数据
        function clearAllData() {
            if (allScores.length === 0) {
                alert('当前没有评分数据');
                return;
            }
            
            if (confirm(`确定要清除所有评分数据吗？\n共${allScores.length}条记录将被永久删除。`)) {
                allScores = [];
                saveScores();
                updateResultsDisplay();
                alert('所有评分数据已清除');
            }
        }
        
        // 页面加载时检查URL参数
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const groupParam = urlParams.get('group');
            
            if (groupParam) {
                currentGroup = decodeURIComponent(groupParam);
                document.getElementById('groupSelect').value = currentGroup;
            }
        }
        
        // 页面加载时检查URL参数
        setTimeout(checkUrlParams, 100);
    </script>
</body>
</html>